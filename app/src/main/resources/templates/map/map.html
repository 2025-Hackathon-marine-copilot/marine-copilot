<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSeaMap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map { height: 600px; }
    </style>
</head>
<body class="flex flex-col items-center p-4">

<!-- ìƒë‹¨ ì œëª© -->
<div class="flex justify-center items-center mb-4">
    <img src="/images/mainLogo.png" class="w-80 h-auto">
</div>
<hr style="margin-bottom: 10px" class="border-t-2 border-gray-300 w-full">

<!-- ğŸ“Œ ëª©ì ì§€ ë° ì„ ë°• ID + ì²˜ìŒìœ¼ë¡œ ê°€ê¸° ë²„íŠ¼ + ë‚ ì”¨ ë²„íŠ¼ -->
<div class="w-full flex justify-between items-center mb-6">
    <!-- ëª©ì ì§€ ë° ì„ ë°• ID -->
    <div id="ship-info" class="text-lg font-semibold">
        ğŸ“ ëª©ì ì§€: ê°ë§Œë¶€ë‘ <br>
        ğŸ†” ì„ ë°• ID: <span id="ship-id">-</span>
    </div>

    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="flex space-x-4">
        <!-- ë‚ ì”¨ ì •ë³´ ë²„íŠ¼ -->
        <button id="weather-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md">
            ğŸŒŠ í•­ë§Œ ê¸°ìƒ ì •ë³´ ë³´ê¸°
        </button>

        <!-- ğŸ“ ê²½ë¡œ ì•ˆë‚´ ë²„íŠ¼ -->
        <button id="route-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md">
            ğŸ“ ê²½ë¡œ ì•ˆë‚´ ë³´ê¸°
        </button>

        <!-- ì²˜ìŒìœ¼ë¡œ ê°€ê¸° ë²„íŠ¼ -->
        <form th:action="@{/}" method="get">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md">
                ì²˜ìŒìœ¼ë¡œ ê°€ê¸°
            </button>
        </form>
    </div>
</div>

<!-- ì§€ë„ ì˜ì—­ -->
<div id="map" class="w-full"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map', {
            center: [35.090625, 129.088557],
            zoom: 14,
            doubleClickZoom: false
    });

    // OpenStreetMap API ê¸°ë³¸ ë ˆì´ì–´
    let baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // OpenSeaMap API ê¸°ë³¸ í•´ì–‘ ë ˆì´ì–´
    let osmLayer = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenSeaMap contributors'
    }).addTo(map);

    // OpenSeaMap API ì‹¬í•´ ìˆ˜ì‹¬ ë ˆì´ì–´
    let depthLayer = L.tileLayer.wms('https://osm.franken.de/geoserver/gwc/service/wms', {
        layers: 'depth_contours',
        format: 'image/png',
        attribution: 'Depth Contours from OpenSeaMap'
    });

    // OpenSeaMap API í•­ë¡œ ë° í•´ì–‘ í‘œì‹ ë ˆì´ì–´ì–´
    let seamarkLayer = L.tileLayer.wms('https://osm.franken.de/geoserver/gwc/service/wms', {
        layers: 'seamarks',
        format: 'image/png',
        attribution: 'Seamarks from OpenSeaMap'
    });

    // ë¶€ì‚°í•­ í•´ì—­ ì¢Œí‘œ
    let latMin = 35.068818, latMax = 35.110009;
    let lonMin = 129.057058, lonMax = 129.117633;
    let gridSize = 0.002423;

    let sizeX = 25;
    let sizeY = 17;

    // ë°ì¹´ë¥´íŠ¸ ì¢Œí‘œê³„ í‘œì‹œ
    for (let lat = latMin, i = 0; i < sizeY; lat += gridSize, i++) {
        for (let lon = lonMin, j = 0; j < sizeX; lon += gridSize, j++) {
            let square = [
                [lat, lon],
                [lat + gridSize, lon],
                [lat + gridSize, lon + gridSize],
                [lat, lon + gridSize]
            ];

            L.polygon(square, {
                color: 'rgba(0, 0, 255, 0.3)',
                weight: 0.8
            }).addTo(map);
        }
    }

    // í•­í•´ ê°€ëŠ¥ ì˜ì—­ í‘œì‹œ
    let navigableCoords = [
        [35.091225, 129.117631],
        [35.091014, 129.099521],
        [35.093505, 129.094758],
        [35.103725, 129.094028],
        [35.103407, 129.074845],
        [35.108181, 129.067292],
        [35.100527, 129.059481],
        [35.095471, 129.070124],
        [35.085939, 129.083382],
        [35.080731, 129.096392],
        [35.068818, 129.095082],
        [35.068818, 129.117631]
    ];

    L.polygon(navigableCoords, {
        color: 'rgba(0, 255, 0, 0.8)',
        weight: 0.8,
        fillColor: 'rgba(0, 255, 0, 0.5)',
        fillOpacity: 0.2
    }).addTo(map)

    // 6. ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    map.on('dblclick', function(event) {
        // ë”ë¸” í´ë¦­í•œ ìœ„ì¹˜ì˜ ìœ„ë„ì™€ ê²½ë„ ì¶œë ¥
        const lat = event.latlng.lat;
        const lng = event.latlng.lng;
        console.log(`í˜„ì¬ ìœ„ì¹˜: ìœ„ë„ ${lat}, ê²½ë„ ${lng}`);

        // 7. ë¹¨ê°„ ì  ì¶”ê°€ (ë§ˆì»¤)
        const redIcon = new L.Icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
            iconSize: [25, 41], // ë§ˆì»¤ í¬ê¸°
            iconAnchor: [12, 41], // ë§ˆì»¤ ì•µì»¤ ìœ„ì¹˜
            popupAnchor: [1, -34], // íŒì—… ì•µì»¤ ìœ„ì¹˜
        });

        // í•´ë‹¹ ìœ„ì¹˜ì— ë¹¨ê°„ ì (ë§ˆì»¤)ì„ ì¶”ê°€
        L.marker([lat, lng], { icon: redIcon }).addTo(map).bindPopup(`ìœ„ë„: ${lat}, ê²½ë„: ${lng}`);
    });

    // ì„ ë°• ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
    function addShipMarker(map, ship, icon) {
        var marker = L.marker([ship.lat, ship.lng], {icon: icon}).addTo(map);
        marker.bindPopup(
            `<b>ğŸš¢ ì„ ë°•ëª…: ${ship.name}</b><br>
             ğŸ†” IMO ë²ˆí˜¸: ${ship.imoNumber}<br>
             ğŸ“ í¬ê¸°: ${ship.width}m x ${ship.height}m<br>
             ğŸ“ ìœ„ì¹˜: ìœ„ë„ ${ship.lat}, ê²½ë„ ${ship.lng}`
        );
    }

    // ğŸŒ¤ ë‚ ì”¨ ì •ë³´ ì»¨íŠ¸ë¡¤ (ìš°ì¸¡ ìƒë‹¨)
    var weatherControl = L.control({ position: 'topright' });

    weatherControl.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'weather-info bg-white p-3 rounded-lg shadow-lg text-sm');
        div.style.display = "none"; // ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€
        div.innerHTML = `<b>ğŸŒŠ í˜„ì¬ í•­ë§Œ ê¸°ìƒ ì •ë³´</b><br>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.`;
        return div;
    };

    weatherControl.addTo(map);
    var weatherControlDiv = document.querySelector('.weather-info');

    // ì…ë ¥ì„ ê²½ë¡œ ë°°ì—´ë¡œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
    function parseCoordinates(input) {
        try {
            return JSON.parse(input);
        } catch (error) {
            alert("ì˜ëª»ëœ í˜•ì‹ì…ë‹ˆë‹¤. [[ìœ„ë„, ê²½ë„], [ìœ„ë„, ê²½ë„], ...] í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.");

            return null;
        }
    }

    // ê²½ë¡œë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
    function drawPath() {
        let inputText = document.getElementById("coordsInput").value;
        let coordinates = parseCoordinates(inputText);

        if (!coordinates)
            return;

        L.polyline(coordinates, {
            color: 'red',
            weight: 3,
            opacity: 0.8,
            smoothFactor: 1
        }).addTo(map);
    }
</script>

<script th:inline="javascript">
    var currentShip = /*[[${currentShip}]]*/ null;
    map.setView([currentShip.lat, currentShip.lng], 10);

    var currentShipIcon = L.icon({
        iconUrl: '/images/current_ship.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });

    document.getElementById("ship-id").innerText = currentShip.imoNumber;
    addShipMarker(map, currentShip, currentShipIcon);
    map.flyTo([currentShip.lat, currentShip.lng], 14, { duration: 1.5 });
</script>

<script th:inline="javascript">
    var anchoredShips = /*[[${anchoredShips}]]*/ [];
    var anchoredShipIcon = L.icon({
        iconUrl: '/images/anchored_ship.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });
    anchoredShips.forEach(ship => addShipMarker(map, ship, anchoredShipIcon));
</script>

<script th:inline="javascript">
    var movingShips = /*[[${movingShips}]]*/ [];
    var movingShipIcon = L.icon({
        iconUrl: '/images/moving_ship.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });
    movingShips.forEach(ship => addShipMarker(map, ship, movingShipIcon));
</script>

<script th:inline="javascript">
    var weatherInfo = /*[[${weatherInfo}]]*/ null;

    document.getElementById("weather-btn").addEventListener("click", function () {
        if (weatherInfo && weatherInfo.tm) {
            // ë‚ ì”¨ ì •ë³´ë¥¼ ìš°ì¸¡ ìƒë‹¨ì— í‘œì‹œ + âŒ X ë²„íŠ¼ ì¶”ê°€
            weatherControlDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <b>ğŸŒŠ í˜„ì¬ í•­ë§Œ ê¸°ìƒ ì •ë³´</b>
                    <button id="close-weather" class="text-red-500 font-bold text-lg">âŒ</button>
                </div>
                â° ê´€ì¸¡ ì‹œê°: ${weatherInfo.tm}<br>
                ğŸŒŠ ìœ ì˜ íŒŒê³ : ${weatherInfo.wh}m<br>
                ğŸŒ¬ í’í–¥: ${weatherInfo.wd}Â°<br>
                ğŸ’¨ í’ì†: ${weatherInfo.ws} m/s<br>
                ğŸŒŠ GUST í’ì†: ${weatherInfo.wsGst} m/s<br>
                ğŸŒ¡ í•´ìˆ˜ë©´ ì˜¨ë„: ${weatherInfo.tw}Â°C<br>
                ğŸŒ¡ ê¸°ì˜¨: ${weatherInfo.ta}Â°C<br>
                ğŸ– í•´ë©´ ê¸°ì••: ${weatherInfo.pa} hPa
            `;

            weatherControlDiv.style.display = "block"; // ë‚ ì”¨ ì •ë³´ í‘œì‹œ

            // âŒ X ë²„íŠ¼ í´ë¦­ ì‹œ ë‚ ì”¨ ì •ë³´ ìˆ¨ê¹€
            document.getElementById("close-weather").addEventListener("click", function () {
                weatherControlDiv.style.display = "none";
            });

        } else {
            alert("ğŸŒ¥ ê¸°ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    });
</script>

<script th:inline="javascript">
    let startPosition = null;
    let goalPosition = null;
    // ì´ë™ ì¤‘ì¸ ì„ ë°•ì˜ lat, lng ê°’ë§Œ ì¶”ì¶œ
    let movingShipCoordinates = movingShips.map(ship => [ship.lat, ship.lng]);

    // ì •ë°• ì¤‘ì¸ ì„ ë°•ì˜ lat, lng ê°’ë§Œ ì¶”ì¶œ
    let anchoredShipCoordinates = anchoredShips.map(ship => [ship.lat, ship.lng]);

    // ğŸŒ ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ (ëª©ì ì§€ ì„ íƒ)
    map.on("click", function(event) {
        const lat = event.latlng.lat;
        const lng = event.latlng.lng;
        goalPosition = [lat, lng];

        console.log("ğŸŸ¢ ëª©ì ì§€ ì„ íƒë¨:", goalPosition);

        // ê¸°ì¡´ ëª©ì ì§€ ë§ˆì»¤ ì œê±° í›„ ìƒˆë¡œìš´ ëª©ì ì§€ ì¶”ê°€
        if (window.goalMarker) {
            map.removeLayer(window.goalMarker);
        }
        window.goalMarker = L.marker(goalPosition, { icon: L.icon({
                iconUrl: 'images/flag.png',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            }) }).addTo(map).bindPopup("ğŸ“ ë„ì°© ìœ„ì¹˜");
    });

    // ğŸ“ ê²½ë¡œ ì•ˆë‚´ ë²„íŠ¼ í´ë¦­ ì‹œ ìš”ì²­
    document.getElementById("route-btn").addEventListener("click", function () {
        if (!goalPosition) {
            alert("ğŸ“ ë„ì°© ìœ„ì¹˜ë¥¼ ì§€ë„ì—ì„œ í´ë¦­í•´ì£¼ì„¸ìš”!");
            return;
        }

        startPosition = [currentShip.lat, currentShip.lng];

        fetch("/route/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start: startPosition, goal: goalPosition, movingShip: movingShipCoordinates, anchoredShip: anchoredShipCoordinates })
        })
            .then(response => response.json())
            .then(data => {
                if (!data.route) {
                    console.error("ğŸš¨ ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                console.log("ğŸš¢ ì¶”ì²œ ê²½ë¡œ:", data.route);

                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                if (window.routeMarkers) {
                    window.routeMarkers.forEach(marker => map.removeLayer(marker));
                }

                // ğŸ”´ ê° ì¢Œí‘œë§ˆë‹¤ ë¹¨ê°„ ì (ë§ˆì»¤) ì¶”ê°€
                window.routeMarkers = [];

                data.route.forEach(coord => {
                    let marker = L.circleMarker([coord.lat, coord.lon], {
                        radius: 5,
                        color: "red",
                        fillColor: "red",
                        fillOpacity: 1
                    }).addTo(map);

                    window.routeMarkers.push(marker);
                });

            })
            .catch(error => console.error("ğŸš¨ ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨:", error));
    });
</script>

</body>
</html>
